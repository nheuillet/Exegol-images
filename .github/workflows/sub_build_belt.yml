name: (level 1 sub) Belt

on:
  workflow_call:
    inputs:
      DOCKER_BUILD_REPO:
        required: true
        type: string
      DOCKER_TARGET_REPO:
        required: false
        default: ''
        type: string
      IMAGE_BASE_NAME:
        required: true
        type: string
      IMAGE_VERSION:
        required: false
        default: ''
        type: string
      ARCH:
        required: true
        type: string
      PR_MODE:
        required: false
        type: boolean
    secrets:
      DOCKER_PASSWORD:
        required: false
      DOCKER_USERNAME:
        required: false
    outputs:
      build:
        description: "Failed build"
        value: ${{ jobs.export_results.outputs.build }}
      push:
        description: "Failed push"
        value: ${{ jobs.export_results.outputs.push }}
      test:
        description: "Failed tests"
        value: ${{ jobs.export_results.outputs.test }}

jobs:
  prune:
    name: Pre-build ${{ inputs.ARCH }} runner clean
    runs-on:
      - self-hosted
      - builder
      - ${{ inputs.ARCH }}
    steps:
      - name: Clean build folder
        run: |
          rm -rf * || true
          rm -rf ./* || true
          rm -rf ./.??* || true
          ls -la ./
      - name: Clean unused dangling images
        # dangling: images that were replaced with ones with the same name and tag
        run: docker image prune --filter "label=org.exegol.app=Exegol" --force
      - name: Clean unused volumes
        run: docker volume prune --force

  build-base:
    name: Build Base Image
    uses: ./.github/workflows/sub_build.yml
    needs: prune
    permissions:
      contents: read
      packages: write
    with:
      DOCKER_BUILD_REPO: ${{ inputs.DOCKER_BUILD_REPO }}
      IMAGE_BASE_NAME: nightly-base
      IMAGE_VERSION: ${{ inputs.IMAGE_VERSION }}
      DOCKERFILE: ${{ if contains(github.event.head_commit.message, 'reset') }}base.dockerfile${{ else }}clean_base.dockerfile${{ endif }}
      ARCH: ${{ inputs.ARCH }}
    secrets: inherit
